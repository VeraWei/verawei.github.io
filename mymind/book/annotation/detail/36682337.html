<!DOCTYPE html><html lang="zh-cmn-Hans" class=" book-new-nav"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>
    第1页
</title>
  
<script>!function(e){var o=function(o,n,t){var c,i,r=new Date;n=n||30,t=t||"/",r.setTime(r.getTime()+24*n*60*60*1e3),c="; expires="+r.toGMTString();for(i in o)e.cookie=i+"="+o[i]+c+"; path="+t},n=function(o){var n,t,c,i=o+"=",r=e.cookie.split(";");for(t=0,c=r.length;t<c;t++)if(n=r[t].replace(/^\s+|\s+$/g,""),0==n.indexOf(i))return n.substring(i.length,n.length).replace(/\"/g,"");return null},t=e.write,c={"douban.com":1,"douban.fm":1,"google.com":1,"google.cn":1,"googleapis.com":1,"gmaptiles.co.kr":1,"gstatic.com":1,"gstatic.cn":1,"google-analytics.com":1,"googleadservices.com":1},i=function(e,o){var n=new Image;n.onload=function(){},n.src="https://www.douban.com/j/except_report?kind=ra022&reason="+encodeURIComponent(e)+"&environment="+encodeURIComponent(o)},r=function(o){try{t.call(e,o)}catch(e){t(o)}},a=/<script.*?src\=["']?([^"'\s>]+)/gi,g=/http:\/\/(.+?)\.([^\/]+).+/i;e.writeln=e.write=function(e){var t,l=a.exec(e);return l&&(t=g.exec(l[1]))?c[t[2]]?void r(e):void("tqs"!==n("hj")&&(i(l[1],location.href),o({hj:"tqs"},1),setTimeout(function(){location.replace(location.href)},50))):void r(e)}}(document);</script>

  
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="Sun, 6 Mar 2005 01:00:00 GMT">
  
  <script>var _head_start = new Date();</script>
  
  <link href="https://img9.doubanio.com/f/book/4cc1d754ffe6fbd776215e84f222dcb2a4265882/css/book/master.css" rel="stylesheet" type="text/css">

  <link href="https://img9.doubanio.com/f/book/222a5c61e041638af8defc87cf97f4a863a77922/css/book/base/init.css" rel="stylesheet">
  <style type="text/css">
  [data-like]{display:inline-block}[data-like] .LikeTagsDialog{right:auto;left:-10px}[data-like] .LikeTagsDialog:after{right:auto;left:25px}.reading-notes{overflow:visible}.reading-notes .ctsh .clst,.reading-notes .comments .con .reading-note{overflow:visible}

.rnote { margin-bottom: 15px }
.rnote .info { border-bottom: 1px dashed #ddd; padding: 0 0 10px 0 }
.rnote .rec-sec { float: right }
.rnote pre { margin-bottom:1.5em;font:12px/162% Arial,Helvetica,sans-serif; white-space: pre-wrap; word-wrap: break-word }
.aside blockquote { margin: 0; width: 20px; float: left; padding: 0; background-position: 0 50% }
.aside blockquote q { padding-right: 10px }

.aside .new-annotation {
  height: 24px;
  line-height: 24px;
  vertical: bottom;
}

.aside .new-annotation,
.annotation-promo {
  margin-bottom: 20px;
}
.annotation-promo a:hover,
.annotation-promo a {
  display: block;
  width: 100%;
  height: 50px;
  line-height: 50px;
  vertical-align: bottom;
  background: url(/pics/book/annotation/ios/promo.png) no-repeat -3px 0px;
  text-indent: -9999px;
}

.aside .disclaimer {
  margin-bottom: 40px;
}
</style>
  <script src="https://img9.doubanio.com/f/book/0495cb173e298c28593766009c7b0a953246c5b5/js/book/lib/jquery/jquery.js"></script>
  <script src="https://img9.doubanio.com/f/shire/22ee83f45f94c7a90e73e0ee4acd18f902a6991f/js/douban.js"></script>
  <script src="https://img9.doubanio.com/f/book/0322e3e810e475f1c82adb7d1c6ccfa1c0fa969c/js/book/master.js"></script>
  

  
  <meta name="mobile-agent" content="format=html5; url=https://m.douban.com/book/annotation/36682337">
  <link href="https://img9.doubanio.com/f/book/8d88a11c4dd76aef91ed41aee85e58eeb757dc59/css/book/notes.css" type="text/css" rel="stylesheet">
  <link href="https://img9.doubanio.com/f/shire/b6814ac068f705a1366083b58858a468706a60dc/css/lib/jquery.snippet.css" type="text/css" rel="stylesheet">
  <link href="https://img9.doubanio.com/f/shire/8377b9498330a2e6f056d863987cc7a37eb4d486/css/ui/dialog.css" type="text/css" rel="stylesheet">
  <script src="https://img9.doubanio.com/f/shire/2c0c1c6b83f9a457b0f38c38a32fc43a42ec9bad/js/do.js" data-cfg-autoload="false"></script>
  <script type="text/javascript" src="https://img9.doubanio.com/f/shire/7965e09b0065d26bfd22d390de956c22a48b9008/js/lib/jquery.snippet.js"></script>
  <link type="text/css" href="https://img9.doubanio.com/f/shire/ce3ccd609585055eee51d0226a7c6bbe5563454a/css/lib/jquery.ui.tooltip.css" rel="stylesheet">
  <script type="text/javascript" src="https://img9.doubanio.com/f/shire/e254005edae24d9a1808ede9c3d7fcc5b6d94e1b/js/lib/jquery.ui.min.js"></script>
  <script type="text/javascript" src="https://img9.doubanio.com/f/shire/5a2413f37f7e0bb326a611cc86f85886f4dc6a97/js/lib/jquery.ui.tooltip.js"></script>
  <script type="text/javascript" src="https://img9.doubanio.com/f/book/26ffd675884db883de565c9a5c9ffdf167ab55c5/js/book/pos_fixed.js"></script>
  <script type="text/javascript">
    $(function () {
      $().fixSide(350, 52)
    })
  </script>
  <script type="text/x-mathjax-config">
MathJax.Hub.Config({
	jax: ["input/TeX", "output/HTML-CSS"],
    extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js","TeX/noUndefined.js"],
    tex2jax: {
		inlineMath: [ ["($", "$)"], ['\\(','\\)'] ],
		displayMath: [ ["($$","$$)"], ['\\[','\\]']],
		skipTags: ["script","noscript","style","textarea"],
		processEscapes: true,
		processEnvironments: true,
		preview: "TeX"
	},
	showProcessingMessages: false
  });
</script>

  <script type="text/javascript" src="https://img9.doubanio.com/f/shire/bc881a837a728ab82aa01d653b1c180190bb5a5d/js/ui/dialog.js"></script>

  <script>  </script>
  <link rel="stylesheet" href="https://img9.doubanio.com/misc/mixed_static/6c667518cf30844a.css">

  <link rel="shortcut icon" href="https://img9.doubanio.com/favicon.ico" type="image/x-icon">
</head>
<body>
  
    <script>var _body_start = new Date();</script>
    
  



    <link href="//img3.doubanio.com/dae/accounts/resources/f55e154/shire/bundle.css" rel="stylesheet" type="text/css">




<script>
  ;window._GLOBAL_NAV = {
    USER_ID: "252269522",
    UPLOAD_AUTH_TOKEN: "252269522:8c1620a4e405d8238e6020df6ec9920a71d914dd",
    SSE_TOKEN: "a254b1705031d44807d249c52f75c6dcaa602f3e",
    SSE_TIMESTAMP: "1640990625",
    DOUBAN_URL: "https://www.douban.com",
    N_NEW_NOTIS: 0,
    N_NEW_DOUMAIL: 0
  };
</script>



    <script src="//img3.doubanio.com/dae/accounts/resources/f55e154/shire/bundle.js" defer="defer"></script>




  



    <link href="//img3.doubanio.com/dae/accounts/resources/f55e154/book/bundle.css" rel="stylesheet" type="text/css">






<script id="suggResult" type="text/x-jquery-tmpl">
  <li data-link="{{= url}}">
            <a href="{{= url}}" onclick="moreurl(this, {from:'book_search_sugg', query:'{{= keyword }}', subject_id:'{{= id}}', i: '{{= index}}', type: '{{= type}}'})">
            <img src="{{= pic}}" width="40" />
            <div>
                <em>{{= title}}</em>
                {{if year}}
                    <span>{{= year}}</span>
                {{/if}}
                <p>
                {{if type == "b"}}
                    {{= author_name}}
                {{else type == "a" }}
                    {{if en_name}}
                        {{= en_name}}
                    {{/if}}
                {{/if}}
                 </p>
            </div>
        </a>
        </li>
  </script>




    <script src="//img3.doubanio.com/dae/accounts/resources/f55e154/book/bundle.js" defer="defer"></script>





    <div id="wrapper">
        
        
  <div id="content">
    
    <h1>第1页</h1>

    <div class="grid-16-8 clearfix">
      
      <div class="article">



<div class="mod profile clearfix">
    
    <div class="info">
        <h6><a href="javascript:void(0)">秋明</a>
          <span class="">(冰火两重天)</span>
        </h6>
        <p><span class="stat">读过</span> <a class="name" href="javascript:void(0)">爱的艺术</a>
        </p>
    </div>
</div>







<div class="mod rnote">
    <div class="bd clearfix">
        <div class="annotation-info">
          <ul>
            <li>
                页码：<span class="page-num">第1页</span>
                <span class="pubtime">2015-12-02 08:32:41</span>
            </li>
          </ul>
        </div>
        <pre id="link-report" class=""><p>“有魅力”一般是指这个人有多令人喜爱、目前又是人口市场上被人问津的特点。什么东西能使一个人有魅力取决于一时的时髦，这不仅指一个人的生理条件，也包括他的精神气质。

如果一个人是在积极情绪支配下行动，他就是自由的，是情绪的主人。如果他是被一种消极的情绪所支配，那他就是受外力驱使者，是他自己都不了解的动机的对象。

他应该把内心有生命力的东西给予别人。

爱情是对生命以及我们所爱之物生长的积极的关心。如果缺乏这种积极的关心，那么这只是一种情绪，而不是爱情。

如果爱情没有第三个要素：尊重，那责任心就很容易变成控制别人和奴役别人。

我只有用他人的眼光看待他人，而把对自己的兴趣退居二位。我才能了解对方。

残暴有一层含义较深的动机：那就是希望认识事物和生命的秘密。

我必须客观地去认识对方和自己，以便使自己能够看到对方的现实状态或者克服幻想，克服我想象中的被歪曲了的他的图像。我只有客观的认识一个人，我才能在爱中了解他的真正的本质。

同性恋的变异是达不到两极结合所造成的，因此同性恋爱者永远不会脱离孤独的折磨。同性恋者同不能施爱的异性恋者，都实现不了两极的结合。（理由在哪里？？）

同父亲的关系则完全不同。母亲是我们的故乡，是大自然、大地和海洋。而父亲不体现任何一种自然渊源。在最初几年内孩子同父亲几乎没有什么联系，在这个阶段父亲的作用几乎无法同母亲相比。父亲虽然不代表自然世界，却代表人类生存的另一个极端：即代表思想的世界，人所创造的法律、秩序和纪律的等事物的世界。父亲是教育孩子，向孩子指出通往世界之路的人。（很有道理，我所以是我）

在孩子身上母亲超越了自我，她对孩子的爱使她的生活产生新的意义。（正因为男子不能通过生育来满足超越自己的要求，所以他只能通过用双手创造物体和创造思想来证明他的创造力。）（我觉得这跟人身上的荷尔蒙有关系。。。）

爱情只能产生于这样的两个人中间，这两个人都从他们生存的圈子里跳出来并互相结合，同时他们每个人都又能脱离自我中心去体验自己。只有这种“中心体验”才是人的现实，才是生活，才是爱情的基础。

爱情的存在只有一个证明：那就是双方联系的深度和每个所爱之人的活力和生命力。这也是我所能看到的爱情的唯一成果。（应该是相爱吧，这种活力和生命力才属于爱情。不然只是自己的活力和生命力）

正因为人们被迫每天八小时为别人的目标付出努力，以一种劳动节奏规定的方式工作，所以他要反叛，而这种反叛就采用了无所作为的态度。（被迫有些牵强了，有人的确是被迫，有人是喜欢，每人都有选择的权利，等价或不等价交换，又没有人拿枪逼着你。）

集中是掌握一门艺术的一个必要条件。（非常需要提高）

但是最重要的是不要把纪律看作是外部强加的东西，而应该成为自我意志的体现，应该感到这是一种愉快，并且逐渐习惯于一种生活态度，一旦放弃它，便会若有所思。

每一件聚精会神完成的事会使人清醒（尽管干完时候出现能恢复的自然疲劳状态）

到底发生了什么？为什么我一蹶不振？同样在我们生气或者迷惑不解的时候，在我们开始想入非非的时候，都应该这样问问自己。

客观是例外，不同程度的自恋是常规。

能进行客观思考的能力就是理智，以理智为基础的感情是谦恭。我们只有摆脱了童年时代妄图得到全知、全能的幻想，才能有客观和运用自己的理智。

而合理的信仰是以相反的体验为基础的。我们相信一种思想，因为这种思想是我们自己的观察和思考的产物。我们相信自己、他人合人类不断发展的可能性，我们对自己的觉悟和成熟体验得越深，我们的信仰度就越高。合理信仰的基础是我们的生产力。在信仰中生活，就是创造性的生活。（为了这种无限的可能性，乐此不疲）

爱的能力要求人全力以赴，要求人的清醒状态和生命力的升华，而这种能力只能通过在生活的许多其他方面的创造性和积极的态度才能获得。


（好像爱上你了。嗯。是的。）</p></pre>
        
    <style>
        #link-report .report { text-align: right; font-size: 12px; visibility: hidden; }
        #link-report .report a { color: #BBB; }
        #link-report .report a:hover { color: #FFF; background-color: #BBB; }
      
.dui-dialog { position:fixed;_position:absolute;z-index:1000; }
.dui-dialog .dui-dialog-content {
  position: relative;
  z-index: 2;
  background: #fff;
  border: 1px solid #bbb;
  -moz-border-radius: 4px;
  border-radius: 4px;
  *zoom: 1;
}
.dui-dialog .hd {
  padding: 10px 10px 6px;
  background: #ebf5eb;
  font-size: 14px;
  -moz-border-radius: 4px;
  border-radius: 4px 4px 0 0;
}
.dui-dialog .hd h3 { padding:0 40px 0 4px;background:none;color:#060; }
.dui-dialog .hd h3 i { color:#060;font-style:normal;margin-left:0.5ex; }
.dui-dialog .bd { position:relative; padding:15px;*zoom:1;font-size:12px;}
.dui-dialog .bd:after { content:&#39;\0020&#39;;clear:both;display:block; }
.dui-dialog .ft .bn-flat,
.dui-dialog .ft input { margin:0 .5em; }
.dui-dialog .ft { text-align:center;padding:10px;padding-top:0; }
.dui-dialog .dui-dialog-close {
  position: absolute;
  top: 10px;
  right: 12px;
  padding: 0 3px;
  z-index: 1;
  font: 11px/1.2 &#34;Comic Sans MS&#34;, sans-serif;
}
a.dui-dialog-close:link { color:#b4b4b4; }
a.dui-dialog-close:hover {color: #fab0b6; background:none; }
.dui-dialog .dui-dialog-shd {
    position:absolute;
    left:-8px;
    top:-8px;
    width:100%;
    height:100%;
    padding:8px;
    background:#666;
    opacity:.4;
    filter:alpha(opacity=50);
    -ms-filter:&#34;alpha(opacity=50)&#34;;
    -moz-border-radius:5px;
    -webkit-border-radius:5px;
    border-radius:5px;
}
.dui-dialog-iframe { border:0;background:transparent;position:absolute;z-index:1;left:-8px;top:-8px;opacity:0;filter:alpha(opacity=0); }
.dui-dialog-msk {
    background:#fff;
    position:absolute;
    width: 100%;
    z-index:999;
    left:0;
    top:0;
    opacity:0.7;
    filter:alpha(opacity=70);
}


    </style>
  <script type="text/javascript" src="https://img9.doubanio.com/f/shire/bc7a779ea587a4a077edb3b6121316f65febbd13/js/report_dialog.js"></script>
  <link rel="stylesheet" type="text/css" href="https://img9.doubanio.com/f/shire/23ff197799d608be56df5dfefb4974fa33f4579b/css/report_dialog.css">
    <script>
        Do = (typeof Do === 'undefined')? $ : Do;
        Do(function(){
          var reportDiv = "#link-report".concat("");
          $("body").delegate(reportDiv, 'mouseenter mouseleave', function(e){

            switch (e.type) {
              case "mouseenter":
                $(this).find(".report").css('visibility', 'visible');
                break;
              case "mouseleave":
                $(this).find(".report").css('visibility', 'hidden');
                break;
            }
          });
          $(reportDiv).delegate(".report a", 'click', function(e){
              e.preventDefault();
              var opt = "";
              var obj = $(e.target).closest(reportDiv);
              var id = obj.length != 0 ? obj.data("id") : undefined;
              var params = (opt&&id) ? '?'.concat(opt, '=', id) : '';
              var url = "https://book.douban.com/annotation/36682337/".concat(params);
              generate_report_dialog({report_url: url});
          });

          $(reportDiv).append('<div class="report"><a rel="nofollow" href="#">投诉</a></div>');
      });
    </script>

        <div class="pl info" style="margin: 1em 0;">
              <span class="">2人阅读</span>
        </div>
            <div style="text-align: right">
              
    
    
    <div class="action-react">
            <a href="javascript:void(0)" data-type="annotation" class=" react-like react-btn" data-reaction_type="0" data-object_id="36682337">
                <span class="react-text">赞</span>
                <span class="react-num"></span>
            </a>
    </div>

    

              





<div class="action-collect">
    <a href="javascript:void(0)" data-id="36682337" data-cate="3049" data-canview="True" data-url="https://book.douban.com/annotation/36682337/" data-catename="" data-link="https://www.douban.com/people/252269522/doulists/all?add=36682337&amp;cat=3049" data-title="第1页" data-picture="https://img9.doubanio.com/f/shire/a28ac64f34a48acd8d058b67be0be50a3d6315f3/pics/doulist_article.png" class="lnk-doulist-add collect-add" onclick="moreurl(this, { 'from':'doulist-btn-3049-36682337-252269522'})">
        <span class="react-text">收藏</span>
        <span class="react-num"></span>
    </a>
</div>

              
    

    

    

    <div class="sharing" data-target="{&quot;url&quot;: &quot;https://book.douban.com/annotation/36682337/&quot;, &quot;desc&quot;: &quot;\u201c\u6709\u9b45\u529b\u201d\u4e00\u822c\u662f\u6307\u8fd9\u4e2a\u4eba\u6709\u591a\u4ee4\u4eba\u559c\u7231\u3001\u76ee\u524d\u53c8\u662f\u4eba\u53e3\u5e02\u573a\u4e0a\u88ab\u4eba\u95ee\u6d25\u7684\u7279\u70b9\u3002\u4ec0\u4e48\u4e1c\u897f\u80fd\u4f7f\u4e00\u4e2a\u4eba\u6709\u9b45\u529b\u53d6\u51b3\u4e8e\u4e00\u65f6\u7684\u65f6\u9ae6\uff0c\u8fd9\u4e0d\u4ec5\u6307\u4e00\u4e2a\u4eba\u7684\u751f\u7406\u6761\u4ef6\uff0c\u4e5f\u5305\u62ec\u4ed6\u7684\u7cbe\u795e\u6c14\u8d28\u3002 \u5982\u679c\u4e00\u4e2a\u4eba\u662f\u5728\u79ef...&quot;, &quot;pic&quot;: &quot;&quot;, &quot;title&quot;: &quot;\u7b2c1\u9875&quot;}">

        <div class="sharing-button">
            <div class="sharing-douban">
                
    

        
            
        

        <div class="rec-sec">


    <span class="rec">
        
            <a data-user_id="252269522" href="javascript:void(0)" share-id="36682337" data-mode="plain" data-name="第1页" data-type="com.douban.book" data-desc="“有魅力”一般是指这个人有多令人喜爱、目前又是人口市场上被人问津的特点。什么东西能使一个人有魅力取决于一时的时髦，这不仅指一个人的生理条件，也包括他的精神气质。 如果一个人是在积..." data-href="https://book.douban.com/annotation/36682337/" data-image="" data-properties="{&quot;href&quot;:&quot;https:\/\/www.douban.com\/people\/nothinganymore\/&quot;,&quot;name&quot;:&quot;秋明&quot;,&quot;uid&quot;:&quot;78857574&quot;}" data-redir="https://book.douban.com/annotation/36682337/vote?ck=nTrr" data-text="" data-apikey="" data-curl="" data-count="10" data-object_kind="3049" data-object_id="36682337" data-target_type="rec" data-target_action="0" data-action_props="{&quot;subject_url&quot;:&quot;https:\/\/book.douban.com\/subject\/3026879\/&quot;,&quot;note_url&quot;:&quot;https:\/\/book.douban.com\/annotation\/36682337\/&quot;,&quot;author_name&quot;:&quot;秋明&quot;,&quot;subject_title&quot;:&quot;爱的艺术&quot;,&quot;note_title&quot;:&quot;第1页&quot;}" data-btn_text="转发" data-heading="转发到豆瓣" data-sanity_key="_81bf7" class="lnk-sharing lnk-douban-sharing">
                    
                            转发
                    
            </a>
    </span>


    </div>

            </div>
        </div>


        
    </div>


            </div>
    </div>
</div>











<script>
    var _COMMENTS_CONFIG = {
        'service': 'annotation',
        'app': 'book',
        'api': '/j/annotation',
        'api_report': 'https://www.douban.com/misc/audit_report',
        'comments': [],
        'total': 0,
        'start': 0,
        'count': 100,
        'user': {"intro":"","is_admin":false,"uid":"252269522","signature":"","url":"https:\/\/www.douban.com\/people\/252269522\/","gender":"","can_delete_all_comments":false,"id":"252269522","avatar":"https://img9.doubanio.com\/icon\/user_large.jpg","name":"豆友252269522"},
        'author': {"intro":"So even if it feels like the whole world is against you, having just one person on your side can make a big difference.\n\nHey, 不管我们认不认识，如果你看到这句话了，那我希望你知道，你已经足够好了呀！","uid":"nothinganymore","is_friend":false,"signature":"冰火两重天","url":"https:\/\/www.douban.com\/people\/nothinganymore\/","gender":"F","id":"78857574","avatar":"https://img9.doubanio.com\/icon\/up78857574-10.jpg","name":"秋明"},
        'target': {"kind":3049,"reply_limit":"A","id":"36682337","can_add_comment":true},
        'options': {
            'only_comment_at_the_end_of_pages': true,
            'enable_comment_sync_to_status': true,
            'bg_color': '#f8f8f4',
            'report_type': 'comment',
        },
        'reportType': 'comment',
        'needEscape': true
    }
</script>
<script src="https://img9.doubanio.com/f/book/800c78874aabeb5194255595b4474647e59f703a/js/book/comments/dist/comments.js"></script>

</div>
      <div class="aside">
        
  
      <fieldset class="pl" style="display:none">
    <legend>仅管理员可见</legend>
    
  
    <script type="text/javascript" src="https://hyjal.dapps.douban.com/raikiri/raikiri.js"></script>
    </fieldset>



<p class="pl2">&gt; <a href="javascript:void(0)">秋明的所有笔记（56篇）</a></p>







<div class="disclaimer">
  
  

  <h2>
    <span>说明</span>
      &nbsp;·&nbsp;·&nbsp;·&nbsp;·&nbsp;·&nbsp;·

  </h2>


  <p class="pl">
    
    表示其中内容是对原文的摘抄
  </p>
</div>

<!-- douban ad begin -->
<div id="dale_book_annotation_top_right"></div>
<!-- douban ad end -->

      </div>
      <div class="extra">
        

      </div>
    </div>
  </div>

        
  

    </div>
      

    <script type="text/javascript" src="https://img9.doubanio.com/misc/mixed_static/46dee2ce0e3cc360.js"></script><script type="text/javascript">
(function(){
    window.collect_target = {
        tkind: "3049",
        tid: "36682337"
    }
    window.update_collect_state = function(collected){
        var ele = document.querySelector('.lnk-doulist-add');
        var old_num = parseInt(ele.querySelector('.react-num').textContent);
        ele.className = 'lnk-doulist-add';
        if(collected){
            ele.className += ' collect-cancel';
            ele.querySelector('.react-text').textContent = '已收藏';
            ele.querySelector('.react-num').textContent = isNaN(old_num) ? 1 : old_num + 1;
        }else{
            ele.className += ' collect-add';
            ele.querySelector('.react-text').textContent = '收藏';
            ele.querySelector('.react-num').textContent = isNaN(old_num) ? "" : old_num - 1 === 0 ? "" : old_num - 1;
        }
    }
})();
function deferred(){var e={done:[],fail:[]},t={done:function(o){return e.done.push(o),t},fail:function(o){return e.fail.push(o),t}};return{resolve:function(){for(var t,o=0;t=e.done[o++];)t.apply(this,arguments)},reject:function(){for(var t,o=0;t=e.fail[o++];)t.apply(this,arguments)},promise:t}}var loader=function(e,t,o,r,n,a){if(e){"function"==typeof t&&(r=t,t=""),"function"==typeof o&&(r=o,o="");var i=function(){loader.loaded[e]=1,r&&r(e),r=null,clearTimeout(d)};if(loader.loaded[e])return loader.loading[e]&&(loader.loading[e]=0),void setTimeout(function(){i()},0);if(loader.loading[e])return void setTimeout(function(){loader(e,t,o,r,n,a)},10);loader.loading[e]=1;var l,d=setTimeout(function(){try{a(e)}catch(e){}},n||6e3),s=t||e.toLowerCase().split(/\./).pop().replace(/[\?#].*/,"");"js"===s?(l=document.createElement("script"),l.setAttribute("type","text/javascript"),l.setAttribute("src",e),l.setAttribute("async",!0)):"css"===s&&(l=document.createElement("link"),l.setAttribute("type","text/css"),l.setAttribute("rel","stylesheet"),l.setAttribute("href",e)),o&&(l.charset=o),"css"===s?setTimeout(function(){i()},0):(l.onerror=function(){i(),l.onerror=null},l.onload=l.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(setTimeout(function(){i()},0),l.onload=l.onreadystatechange=null)});var c=function(){var e=document.getElementsByTagName("script");return e[e.length-1]}();c.parentNode.insertBefore(l,c)}};loader.loaded=window.__external_files_loaded=window.__external_files_loaded||{},loader.loading=window.__external_files_loading=window.__external_files_loading||{},loader.batch=function(){if(0!=arguments.length){var e=Array.prototype.slice.call(arguments);"[object Array]"==Object.prototype.toString.call(e[0])&&(e=e[0]);for(var t,o=deferred(),r=[],n=function(){r.pop(),0===r.length&&o.resolve()},a=0;t=e[a++];)r.push(t),loader(t,n);return o.promise}};
Do(function() {
  loader.batch([
    'https://img9.doubanio.com/f/shire/8377b9498330a2e6f056d863987cc7a37eb4d486/css/ui/dialog.css',
    'https://img9.doubanio.com/f/shire/bc881a837a728ab82aa01d653b1c180190bb5a5d/js/ui/dialog.js'
  ]).done(function() {
    var encodeHTML = function(s) {
    return s.replace(/\&/g, '&amp;')
            .replace(/\"/g, '&quot;')
            .replace(/\'/g, '&apos;')
            .replace(/\</g, '&lt;')
            .replace(/\>/g, '&gt;');
};

function deferred() {
  var callbacks = {
    done: [],
    fail: []
  };

  var promise = {
    done: function(callback) {
      callbacks.done.push(callback);
      return promise;
    },

    fail: function(callback) {
      callbacks.fail.push(callback);
      return promise;
    }
  };

  return {
    resolve: function() {
      var i = 0, cb;
      for(;cb = callbacks['done'][i++];) {
        cb.apply(this, arguments);
      }
    },

    reject: function() {
      var i = 0, cb;
      for(;cb = callbacks['fail'][i++];) {
        cb.apply(this, arguments);
      }
    },

    promise: promise 
  };
}
;
function asyncRequest(url, params, method) {
  var defer = deferred();
  var xhr = null;
  var t = (method || 'get').toLowerCase();
  xhr = $.ajax({
    url: url,
    type: t, 
    dataType: 'json',
    data: (t === 'post')? $.extend(params, {ck: get_cookie('ck')}) : params,
    error: function(e) {
      defer.reject(e);
    },
    success: function(e) {
      defer.resolve(e);
    }
  });

  defer.promise.abort = function() {
    xhr && xhr.abort();
  }
  return defer.promise;
}
;
var DOULIST_ADDITEM = '/j/doulist/{doulist_id}/additem';
var DOULIST_REMOVEITEM = '/j/doulist/{doulist_id}/removeitem';
var DOULIST_EDITITEM = '/j/doulist/{doulist_id}/edititem';
var DOULIST_COMMENT = '/j/doulist/{doulist_id}/poke';
var DOULIST_CREATE = '/j/doulist/add';
var DOULIST_LIST = '/j/doulist/cat';
var DOULIST_SEARCH = '/j/doulist/search';
var DOULIST_SEARCH_SELF = '/j/doulist/search_user_doulists';
var DOULIST_GET_ITEM_INFO = '/j/doulist/get_item_info';
var SUBJECT_DOULIST_LIST = '/j/doulist/subject_doulists'; // 片单|书单
;
var validateForm = function(frm, rules) {
  var bool = true;
  var inp;
  for (var n in rules) {
    if (rules.hasOwnProperty(n)) {
      inp = frm.find(n);
      bool = rules[n](inp);
      if (bool) {
        validateForm.cleanError(inp);
      }
    }
  }
  return bool;
};

validateForm.displayError = function(inp, error) {
  if (!inp) {
    return;
  }
  var item = inp.closest('.item');
  var errorNode = item.find('.form-field-error');
  if (errorNode.length === 0) {
    errorNode = $('<div class="form-field-error"></div>').prependTo(item);
  }
  errorNode.show().html(error);
};

validateForm.cleanError = function(inp) {
  inp.closest('.item').find('.form-field-error').hide();
};



function doulistCustomeEvents(dialog) {
  var cancelBtn = dialog.node.find('.bn-cancel');
  dialog.node.bind('dialog-error', function(e, error) {
    dialog.setContent(
      '<div class="doulist-submit-success"><p>' + error + '</p>\
         <div class="item-submit">\
           <span class="bn-flat"><input type="button" value="关闭" class="bn-cancel"></span>\
         </div>\
       </div>\
      '
    ).update();
    cancelBtn.click(function() {
      dialog.close();
    });
    setTimeout(function() {
      dialog.close();
    }, 3000);
  });

  dialog.node.bind('dialog-success', function(e, doulist) {
    title = doulist.__title || "添加成功"
    action = doulist.__action || '已经添加到<a href="' + doulist.url + '" target="_blank"> ' + doulist.name + '</a>';
    dialog.setTitle(title).setContent(
      '<div class="doulist-submit-success">\
         <i></i>' + action + '\
         <div>\
           <p>窗口将在<b class="num">3</b>秒后关闭</p>\
           <span class="bn-flat"><input type="button" value="关闭" class="bn-cancel"></span>\
         </div>\
       </div>\
      '
    );
    cancelBtn = dialog.node.find('.bn-cancel');
    cancelBtn.click(function() {
      dialog.close();
      timer && clearTimeout(timer);
    });
    var num = dialog.node.find('.num')
      , count = num.text()
      , countdown, timer
    ;(function() {
      countdown = countdown || arguments.callee;
      timer = setTimeout(function() {
        num.text(--count);
        count? countdown(): dialog.close();
      }, 1000);
    })();
  });
}
;
var doulistDialogForm = typeof doulistDialogForm === 'undefined'? {} : doulistDialogForm

;(function() {
  var initForm = function(dialog) {
    var frm = dialog.node.find('form');

    frm.submit(function(e){
      e.preventDefault();
      var frmData = {
        subjectId: frm.find('input[name=subject_id]').val(),
        subjectKind: frm.find('input[name=subject_kind]').val(),
        subjectUrl: frm.find('input[name=subject_url]').val(),
        subjectIsUrlSubject: frm.find('input[name=subject_is_url_subject]').val() == "true",
        comment: frm.find('textarea[name="comment"]').val(),
        sync: frm.find('#dlg-opt-share').attr('checked')? '1': ''
      };
      existListHandler(dialog, frm, frmData)
        .bind('form-submit-error', function(e, error) {
          dialog.node.trigger('dialog-error', error);
        })
        .bind('form-submit-success', function(e, doulist) {
          dialog.node.trigger('dialog-success', doulist);
        })
    });
    frm.bind('form-submit-fail', function(e, msg){
      validateForm.displayError(frm.find('input[name=dl_title]'), msg);
    });
    doulistCustomeEvents(dialog);
  }

  function existListHandler(dialog, frm, frmData) {
    var doulistSelect = frm.find('input[name=dl_id]:checked');
    var doulistId = doulistSelect.val();
    var doulistName = doulistSelect.next().find('b').text();
    var validateRules = {
      '.dl_exist_select input:checked': function(e) {
        if (!e.length) {
          validateForm.displayError($('.dl_exist_select'), '请选择一个豆列');
          return false;
        }
        return true;
      }
    }
    if(!doulistId && window.hasCancelCollectAction === true){
      var obj = {
        __title: "取消收藏成功",
        __action: "已经取消了收藏"
      }
      setTimeout(function(){
        frm.trigger('form-submit-success', obj);
      }, 500)
      window.update_collect_state && window.update_collect_state(false);
      window.hasCancelCollectAction = null;
      return frm;
    }
    if (validateForm(frm, validateRules)) {
      var data = {
        /* local-dev
        // sid: '25839662', // movie
        // sid: '24879016', // book
        */
        sid: frmData.subjectId,
        skind: frmData.subjectKind,
        comment: frmData.comment,
        sync_to_mb: frmData.sync
      }
      if(frmData.subjectIsUrlSubject){
        data.surl = frmData.subjectId
        delete data.sid
        delete data.skind
      }
      asyncRequest(
        DOULIST_ADDITEM.replace('{doulist_id}', doulistId),
        data,
        'post'
      ).done(function(res) {
        if (res.r) {
          frm.trigger('form-submit-error', res.err);
          return;
        }

        res.sid = frmData.subjectId;
        res.doulist_id = doulistId;
        res.name = $.trim(encodeHTML(doulistName));

        window.update_collect_state && window.update_collect_state(true);
        frm.trigger('form-submit-success', res);
      });
    }
    return frm;
  }

  doulistDialogForm.initForm = initForm;
})()
;
// ref: docs/widgets/doulist_btn.html

;(function($){
var current_doulist_dialog;

window.hasCancelCollectAction = null;

var params = window.collect_target || {};
if (!params.limit) {
  params.limit = 10;
}
params.start = 0;

/* local-dev */
// params.tkind = '1001'
// params.tid = '33387422'

var pureDoulistParams = {
  tkind: params.tkind,
  tid: params.tid,
  start: 0,
  limit: params.limit
};

var searchParams = {
  start: 0,
  limit: params.limit
}

var total;
var pureDoulistTotal;
var searchDoulistTotal;
var status = '';
var pureDoulistStatus = '';
var searchDoulistStatus = '';
var allSubjectDoulsitLoaded = false;
var searchKeyword = ''
var noMoreSearchResult = false;
var inputLock = false;

var DOULIST_ITEM_TMPL = '\
  <div class="dl-item-wrap"\
   data-category="{{category}}"\
   data-doulist-type="{{doulist_type}}"\
   data-is-syncing-from-note="{{is_syncing_from_note}}"\
   data-sync-note-id="{{sync_note_id}}">\
    <input type="radio" value="{{id}}" id="{{id}}" name="dl_id"> \
    <label for="{{id}}"> \
      <span>{{count}}</span> \
      <b data-is-private="{{is_private}}"> \
        <i data-id="{{id}}" data-name="{{name}}" data-is-collected="{{is_collected}}" class="cancel-collect-btn"></i> \
        {{name}} \
      </b> \
    </label> \
  </div>';
var loader = '<div class="loading" style="float: none; width: auto; margin: 4px; background-position: center center;"></div>';

function debounce(func, wait, immediate) {
  var timeout;
  return function() {
    var context = this, args = arguments;
    var later = function() {
      timeout = null;
      if (!immediate) func.apply(context, args);
    };
    var callNow = immediate && !timeout;
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
    if (callNow) func.apply(context, args);
  };
};

var DOULIST_CATEGORY_TEXT = {
  'movie': '片单',
  'tv': '片单',
  'book': '书单'
}

function getDigestTypeText(type) {
  var text = type && DOULIST_CATEGORY_TEXT[type] ? DOULIST_CATEGORY_TEXT[type] : '';
  return text;
}

function isStartsWithPrefixWord(str, type) {
  var separator = ['｜', '丨', '|']; // 三种不同类型的分隔符
  return separator.some((sep) => {
    var reg = new RegExp('^' + getDigestTypeText(type) + "\\"  + sep);
    return reg.test(str);
  })
};

function DoulistDialog(node, config) {
  showDoulistDialog(config);
  node.trigger('dialog:show', current_doulist_dialog);

  getAllDoulist(config, function() {
    handleDoulist(config);
    handleNewDoulist(config);
    handleDoulistSearch(config);
    handleCancelCollect(config);
    handleSelectDoulist(config);
  });
  doulistDialogForm.initForm(current_doulist_dialog);
}

function showDoulistDialog(config) {
  if (current_doulist_dialog) {
    current_doulist_dialog.close();
  }
  config.picture = config.picture || '/pics/doulist_article.png';

  /* local-dev */
  // config.cate = '1001'

  var header = config.cate === '1001' ?
    '<h3>选择书单</h3>\
    <input type="button" name="dl_choose" id="dl_new" autocomplete="off" class="lnk-flat" value="创建书单" />' :
    config.cate === '1002' ? 
    '<h3>选择片单</h3>\
    <input type="button" name="dl_choose" id="dl_new" autocomplete="off" class="lnk-flat" value="创建片单" />' :
    '<h3>选择豆列</h3>\
    <input type="button" name="dl_choose" id="dl_new" autocomplete="off" class="lnk-flat" value="创建豆列" />';
  var title = config.cate === '1001' ? '输入新书单名称' : config.cate === '1002' ? '输入新片单名称' : '输入新豆列名称'

  var dialog = current_doulist_dialog = dui.Dialog({
    title: config.cate === '1002' ? '添加到片单' : config.cate === '1001' ? '添加到书单' : '收藏到豆列',
    width: 640,
    cls: 'dialog-doulist',
    content:
      (config.canview === 'False' ?
        '<div class="doulist-ft" style="text-align:left;">啊，该内容你没有权限查看或已被作者删除。</div>' :
        '<form action="" method="post"><div style="display:none;"><input type="hidden" name="ck" value="nTrr"/></div>\
          <div class="doulist-bd">\
            <div class="doulist-preview">\
              <div><img src="{{picture}}" /></div>\
              <p class="item-title">{{title}}</p>\
            </div>\
            <div class="doulist-content">\
              <div class="item">\
                <div class="item-hd">\
                  <input type="text" name="search" class="dl_search" autocomplete="off" placeholder="请输入豆列名称" maxlength="40" />\
                  <a href="javascript: void 0;" class="clear_search">×</a>' +
                  header +
                '</div>\
                <div class="dl-bd">\
                  <div class="dl-item">\
                    <div class="dl_new_title" style="display: none;">\
                      <div class="dl_title_block"> \
                        <input id="dl_title" type="text" class="basic-input dl-title" placeholder="' + title + '" maxlength="40" />\
                      </div> \
                      <div class="dl_action_block"> \
                        <div class="dl_create_option">\
                          <span>隐私设置：</span> \
                          <input id="doulist_is_not_secret" type="radio" name="is_private" value="false" checked /> \
                          <label for="doulist_is_not_secret">所有人可见</label> \
                          <input id="doulist_is_secret" type="radio" name="is_private" value="true" /> \
                          <label for="doulist_is_secret">仅自己可见</label> \
                        </div> \
                        <input type="button" class="lnk-flat dl_new_submit" disabled value="创建" />\
                      </div> \
                    </div>\
                  </div>\
                  <div class="dl-loading">\
                    加载中...\
                  </div>\
                </div>\
              </div>\
              <div class="item">\
                <div class="item-hd">\
                  <h3>推荐语<span>（选填）</span></h3>\
                </div>\
                <textarea id="doulist_item_comment" class="basic-textarea" name="comment" placeholder="告诉大家你添加它的理由吧"></textarea>\
              </div>\
              <input type="hidden" name="dl_cat" value="{{cate}}">\
              <input type="hidden" name="subject_id" value="{{id}}">\
              <input type="hidden" name="subject_kind" value="{{cate}}">\
              <input type="hidden" name="subject_url" value="{{url}}">\
              <input type="hidden" name="subject_is_url_subject" value="{{isurlsubject}}">\
              </div>\
            </div>\
            <div class="doulist-ft">\
              <a target="_blank" href="https://www.douban.com/service/bookmarklet" class="lnk-bookmarklet">小工具：从浏览器直接把网页内容加入豆列</a>\
              <span class="bn-flat cancel_btn"><input type="button" class="j_close_dialog" value="取消"></span>\
              <span class="bn-flat"><input type="submit" class="doulist_submit" value="保存"></span>\
            </div>\
        </form>\
      ').replace(/{{[^{}]+}}/g, function(match) {
        return (encodeHTML(config[match.replace(/[{}]/g, "")]+"").toString());
      })
    }, true).open();

  dialog.update();

  dialog.node.bind('dialog:close', function() {
    dialog.node.remove();
  });

  dialog.node.bind('dialog:change', function() {
    dialog.update();
  });

  // 重置一下各项参数
  params.tkind = config.cate;
  params.tid = config.id;
  params.start = 0;
  pureDoulistParams.tkind = config.cate;
  pureDoulistParams.tid = config.id;
  pureDoulistParams.start = 0;
  searchParams.start = 0;

  status = '';
  pureDoulistStatus = '';
  searchDoulistStatus = '';
  allSubjectDoulsitLoaded = false;

  clearSearch();
}

// 获取包含书单、片单的全部豆列
function getAllDoulist(config, callback) {
  if (config.cate === '1001') {
    getMixedDoulist('book', callback);
  } else if (config.cate === '1002') {
    getMixedDoulist('movie', callback);
  } else {
    getMixedDoulist('common', callback);
  }
}

// 获取已有的片单/书单
function getMixedDoulist(category, callback) {
  var appendPureDoulists = function() {
    if (pureDoulistParams.start >= pureDoulistTotal || pureDoulistStatus === 'pending') {
      return;
    }

    pureDoulistStatus = 'pending';
    $('.dl_exist_select').append(loader);
    asyncRequest(DOULIST_LIST, {
      tkind: pureDoulistParams.tkind,
      tid: pureDoulistParams.tid,
      start: pureDoulistParams.start,
      limit: pureDoulistParams.limit
    })
    .done(function(pureDoulistResp) {
      var DL_TMPL = DOULIST_ITEM_TMPL;

      // 直接请求纯豆列，并且是第一次加载的时候
      if (pureDoulistParams.start === 0 && category === 'common') {
        if (pureDoulistResp.total) {
          var DL_STR = '<div class="dl_exist_select">';
          $(pureDoulistResp.doulist).each(function(i, dl) {
            DL_STR += DL_TMPL.replace(/{{[^{}]+}}/g, function(match) {
              var matched = dl[match.replace(/[{}]/g, "")];
              return matched && encodeHTML(matched.toString()) || "";
            });
          });
          DL_STR += '</div>';
          $('<div />', {'class': 'dl-item dl-item-exist'}).insertAfter($('.dl-item')).append(DL_STR);
        } else {
          $('<div />', {'class': 'dl-item dl-item-exist'}).insertAfter($('.dl-item')).append(
            '<div class="dl_exist_select"><div class="empty-list">还未创建豆列</div></div>'
          );
        }
      } else {
        var DL_STR = '';
        $(pureDoulistResp.doulist).each(function(i, dl) {
          DL_STR += DL_TMPL.replace(/{{[^{}]+}}/g, function(match) {
            var matched = dl[match.replace(/[{}]/g, "")];
            return matched && encodeHTML(matched.toString()) || "";
          });
        });
        $('.dl_exist_select').append(DL_STR);
      }

      pureDoulistParams.start = pureDoulistParams.start + pureDoulistParams.limit;
      pureDoulistTotal = pureDoulistResp.total;
      pureDoulistStatus = 'success';

      $('.dl-item-exist .loading').remove();

      settleDoulistItemStatus(category)

      var dialog = current_doulist_dialog;
      dialog.node.find('form #doulist_item_comment').val(pureDoulistResp.comment);

      if (pureDoulistParams.start >= pureDoulistTotal) {
        $('.dl_exist_select').append('<div style="padding: 14px 0; text-align: center; color: #666;">没有更多了</div>');
      }

      if (category === 'common') {
        callback && callback()
      }

    }).fail(function() {
      $('.dl-loading').text('+_+ 加载失败，请刷新重试');
      pureDoulistStatus = 'error';
      $('.dl-item-exist .loading').remove();
    })
  }

  if (allSubjectDoulsitLoaded || category === 'common') {
    appendPureDoulists();
    return;
  }

  if (params.start >= total || status === 'pending') {
    return;
  }

  status = 'pending';
  $('.dl_exist_select').append(loader);

  asyncRequest(SUBJECT_DOULIST_LIST, {
    start: params.start + getJustCreatedNewListsCount(),
    limit: params.limit,
    tkind: params.tkind,
    tid: params.tid
  }).done(function(resp) {
    var DL_TMPL = DOULIST_ITEM_TMPL;

    // 第一次加载的时候
    if (params.start === 0) {
      if (resp.total) {
        var DL_STR = '<div class="dl_exist_select">';
        $(resp.doulist).each(function(i, dl) {
          DL_STR += DL_TMPL.replace(/{{[^{}]+}}/g, function(match) {
            var matched = dl[match.replace(/[{}]/g, "")];
            return matched && encodeHTML(matched.toString()) || "";
          });
        });
        DL_STR += '</div>';

        $('<div />', {'class': 'dl-item dl-item-exist'}).insertAfter($('.dl-item')).append(DL_STR);
      } else {
        var typeStr = category === 'book' ? '书单' : category === 'movie' ? '片单' : '';
        $('<div />', {'class': 'dl-item dl-item-exist'}).insertAfter($('.dl-item')).append(
          '<div class="dl_exist_select"><div class="empty-list">还未创建' + typeStr + '</div></div>'
        );
      }
    } else {
      var DL_STR = '';
      $(resp.doulist).each(function(i, dl) {
        DL_STR += DL_TMPL.replace(/{{[^{}]+}}/g, function(match) {
          var matched = dl[match.replace(/[{}]/g, "")];
          return matched && encodeHTML(matched.toString()) || "";
        });
      });

      $('.dl_exist_select').append(DL_STR);
    }

    $('.dl_new_title').hide();

    params.start = params.start + params.limit;
    total = resp.total;
    status = 'success';

    $('.dl-item-exist .loading').remove();

    settleDoulistItemStatus(category)

    var dialog = current_doulist_dialog;
    dialog.node.find('form #doulist_item_comment').val(resp.comment);

    callback && callback()

    // 拿到全部的片单/书单后，再去获取纯豆列
    if (params.start >= total) {
      allSubjectDoulsitLoaded = true;

      if (pureDoulistParams.start === 0) {
        $('.dl_exist_select').append('<div class="test" style="font-size: 15px; padding-top: 15px; margin: 10px 0; color: #666; border-top: 1px solid #DFDFDF; ">收藏到豆列</div>')
      }

      appendPureDoulists()
    }
  }).fail(function() {
    $('.dl-loading').text('+_+ 加载失败，请刷新重试');
    status = 'error';
    $('.dl-item-exist .loading').remove();
  });
}


// 针对列表里单个豆列做修改
function settleDoulistItemStatus(targetCategory, isSearch) {
  var dialog = current_doulist_dialog;
  var $items = isSearch ? dialog.node.find('.search-result-list .dl-item-wrap') : dialog.node.find('.dl_exist_select .dl-item-wrap');

  $items.each(function(e, doulist) {
    var $d = $(doulist);
    var doulist_category = $d.attr('data-category');
    var doulist_type = $d.attr('data-doulist-type');
    var is_syncing_from_note = $d.attr('data-is-syncing-from-note');
    var sync_note_id = $d.attr('data-sync-note-id');
    var is_collected = $d.find('.cancel-collect-btn').attr('data-is-collected');

    // 如果已经收藏过了，不能再选择
    // if (is_collected) {
      // $d.find('input').attr('disabled', true)
    // }

    // 不能直接添加到条目豆列
    if (is_syncing_from_note) {
      $d.find('input').attr('disabled', true);
    } 

    if (is_syncing_from_note && sync_note_id && targetCategory === doulist_category) {
        var act = is_collected ? '去移除' : '去添加';
        $d.find('span').html('<a target="_blank" href="//www.douban.com/note/' + sync_note_id + '/edit">' + act + '&gt;</a>');
    }
  })
}

// 获取通过弹窗新建的列表数量，用来在滚动加载时重新计算 start 值
function getJustCreatedNewListsCount() {
  var dialog = current_doulist_dialog;
  var dl_exist = $('.dl_exist_select');
  var count = 0;
  dl_exist.find('.dl-item-wrap').each(function(i, item) {
    if ($(item).hasClass('just-created')) {
      count++
    }
  })
  return count
}

function handleCancelCollect(config){
  var $cancelBtn = $('.cancel-collect-btn');
  $cancelBtn.click(function(e){
    e.stopPropagation();
    e.preventDefault();
    if (!confirm("确定要移除吗？")) return;

    var did = $(this).attr('data-id');
    var url = DOULIST_REMOVEITEM.replace('{doulist_id}', did);
    var param = window.collect_target || {};
    var $btn = $(this);
    param.ck = get_cookie('ck');
    param.tkind = config.cate;
    param.tid = config.id;
    asyncRequest(url, param, "post").done(function(res){
      if (res.r === 0) {
        $btn.attr('data-is-collected', 'false');
        $btn.closest('label').find('span').html('');
        var $root = $btn.closest('label').parent();
        $root.find('input[type="radio"]').get(0).checked = false;
        $root.find('input[type="radio"]').attr('disabled', false);
        $root.removeClass('checked_dl');
        window.hasCancelCollectAction = true;
      } else {
        alert("取消收藏时遇到了错误: " + res.err);
      }
    })
  });
}

function handleDoulist(config) {
  var dialog = current_doulist_dialog;
  var dl_new = $('#dl_new');
  var dl_new_title = $('.dl_new_title');
  var dl_title = $('#dl_title');
  var dl_exist = $('.dl-item-exist');
  var dl_id = $('#dl_id');

  dl_new.click(function() {
    var form_error = $('.form-field-error');
    if (dl_new_title.is(':hidden')) {
      form_error.show() && dl_new.val('取消创建');
      dl_new_title.slideDown(function() {
        dl_exist.addClass('fold');
        dl_title.focus();
      });
    } else {
      var typeStr = config.cate === '1001' ? '书单' : config.cate === '1002' ? '片单' : '豆列';
      form_error.hide() && dl_new_title.hide() && dl_new.val('创建' + typeStr) && dl_exist.removeClass('fold');
    }
  });

  // 滚动加载
  // stop page scrolling
  dl_exist.bind('scroll', debounce(function(e) {
    var scrollTop = $(this).scrollTop();
    var scrollHeight = $(this).height();
    var windowHeight = $(".dl_exist_select:visible").height();

    if (scrollTop + scrollHeight + 30 >= windowHeight) {
      e.preventDefault();
      if (dl_exist.find('.search-result-list').size() > 0 && searchDoulistStatus !== '') {
        searchDoulist(config, true)
      } else {
        getAllDoulist(config)
      }
    }
  }, 300));
}

function handleSelectDoulist(config) {
  var dialog = current_doulist_dialog;
  dialog.node.delegate(':radio', 'change', function() {
    var $t = $(this);
    // 排除「新建豆列、片单、书单」表单里的「所有人可见」「仅自己可见」
    if ($t.parents('.dl_create_option').size() > 0) {
      return;
    }
    var did = $t.val();
    var url = DOULIST_COMMENT.replace('{doulist_id}', did);

    // 日记同步的豆列不可选
    if ($t.parent().attr('data-is-syncing-from-note')) {
      return;
    }

    asyncRequest(
      url, {
        /* local-dev */
        // sid: '25839662', // movie
        // sid: '33387422', // book
        sid: config.id,
        skind: config.cate
      }
    ).done(function(e){
      dialog.node.find('form #doulist_item_comment').val(e.comment);
    }).fail(function(){
      // ignore
    });
  });
}

function handleNewDoulist(config) {
  var dialog = current_doulist_dialog;
  var dl_new_title = $('.dl_new_title');
  var dl_title = $('#dl_title');
  var dl_new_submit = $('.dl_new_submit');

  dl_title.bind('keyup change', function() {
    if ($.trim(dl_title.val()).length) {
      dl_new_submit.removeAttr('disabled');
    } else {
      dl_new_submit.attr('disabled', true);
    }
  });

  dl_title.bind('keydown', function(e) {
    if (e.keyCode === 13) {
      newListHandler(dialog, dl_new_title, config);
      return false;
    }
  });

  dl_new_submit.click(function() {
    newListHandler(dialog, dl_new_title, config);
  });
}

function renderSearched(res, category) {
  var DL_TMPL = DOULIST_ITEM_TMPL;
  DL_TMPL = DL_TMPL.replace(/value="{{id}}" id="{{id}}"/g, 'value="{{id}}" id="search-{{id}}"').replace(/for="{{id}}"/g, 'for="search-{{id}}"');
  var RESULT = '';
  $(res.doulists).each(function(i, dl) {
    RESULT += DL_TMPL.replace(/{{[^{}]+}}/g, function(match) {
      var matched = dl[match.replace(/[{}]/g, "")];
      return matched && encodeHTML(matched.toString()) || "";
    });
  });

  $('.dl-item-exist .search-result-list').append(RESULT);

  settleDoulistItemStatus(category, true)
}

function handleDoulistSearch(config) {
  var dl_search = $('.dl_search');
  var dl_exist = $('.dl-item-exist');
  var dl_new_title = $('.dl_new_title');
  var dl_new = $('#dl_new');
  var clear_search_btn = $('.clear_search');

  clear_search_btn.click(function() {
    dl_search.val('').change();
    clearSearch()
  });

  dl_search.focus(function() {
    $(this).addClass('expand');
    if (!dl_new_title.is(':hidden')) {
      var form_error = $('.form-field-error');
      var typeStr = config.cate === '1001' ? '书单' : config.cate === '1002' ? '片单' : '豆列';
      form_error.hide() && dl_new_title.hide() && dl_new.val('创建' + typeStr) && dl_exist.removeClass('fold');
    }
  });

  dl_search.bind({
    'compositionstart': function () {
        inputLock = true;
    },
    'compositionend': function () {
        inputLock = false;
    },
    'input': function () {
      setTimeout(() => {
        if (inputLock) return;

        var currenKeyword = $.trim(dl_search.val());
        if (currenKeyword.length && searchKeyword !== currenKeyword) {
          noMoreSearchResult = false;
          searchDoulist(config);
        } else if (currenKeyword.length === 0) {
          clearSearch();
        }
      }, 100);
    }
  })
}

function clearSearch() {
  var dl_search = $('.dl_search');
  var dl_exist = $('.dl-item-exist');
  var clear_search_btn = $('.clear_search');

  $('.no-match-warning').hide();
  dl_exist.find('.dl_exist_select').show();
  dl_exist.find('.search-result-list').remove();
  searchParams.start = 0;
  searchDoulistTotal = null;
  searchDoulistStatus = '';
  // dl_exist.children().show();
  clear_search_btn.hide();
  dl_search.val('');
  searchKeyword = '';
  currenKeyword = '';
  noMoreSearchResult = false;
}

function show_no_match() {
  var dl_exist = $('.dl-item-exist');
  $('.no-match-warning').length ? $('.no-match-warning').show() : dl_exist.before('<p class="no-match-warning">没有找到匹配结果，可以换个关键词试试</p>');
}

function searchDoulist(config, isScrollAppend) {
  var promise = null;
  var dl_search = $('.dl_search');
  var dl_exist = $('.dl-item-exist');
  var dl_new_title = $('.dl_new_title');
  var dl_new = $('#dl_new');
  var clear_search_btn = $('.clear_search');

  var currenKeyword = $.trim(dl_search.val());

  if (promise) {
    promise.abort();
  }
  if (searchDoulistStatus === 'pending' || noMoreSearchResult) {
    return
  }

  $('.no-match-warning').hide();
  if (!isScrollAppend) {
    dl_exist.find('.search-result-list').remove();
  }

  clear_search_btn.hide();
  dl_search.addClass('loading');
  searchKeyword = currenKeyword;
  searchDoulistStatus = 'pending';
  const category = config.cate === '1001' ? 'book' : config.cate === '1002' ? 'movie' : '';

  promise = asyncRequest(
    DOULIST_SEARCH_SELF,
    {
      'limit': 5,
      'start': isScrollAppend ? searchParams.start : 0,
      'q': currenKeyword,
      'category': category
    }
  );
  promise.done(function(res) {
    dl_search.removeClass('loading');
    clear_search_btn.show();
    searchDoulistStatus = 'success';
    if (isScrollAppend) {
      searchParams.start = searchParams.start + searchParams.limit
    }

    if (res && res.doulists && res.doulists.length > 0) {
      if ($('.dl-item-exist .search-result-list').size() === 0) {
        $('.dl-item-exist .dl_exist_select').hide().after('<div class="search-result-list dl_exist_select"></div>')
      }
      renderSearched(res, category)
    } else {
      noMoreSearchResult = true;
      if (searchParams.start === 0) {
        dl_exist.find('.dl_exist_select').hide();
        dl_exist.find('.search-result-list').remove();
        show_no_match();
      } else {
        dl_exist.find('.search-result-list').append('<div style="padding: 14px 0; text-align: center; color: #666;">没有更多了</div>');
      }
    }
  }).fail(function() {
    noMoreSearchResult = true;
    dl_exist.find('.dl_exist_select').hide();
    dl_exist.find('.search-result-list').remove();
    show_no_match();
    dl_search.removeClass('loading');
    clear_search_btn.show();
    searchDoulistStatus = 'error';
  });
}

// 表单验证（创建豆列/片单/书单时）
function newListHandler(dialog, wrap, config) {
  var DL_TMPL = '<div class="just-created dl-item-wrap"><input type="radio" value="{{id}}" id="{{id}}" name="dl_id" checked="checked"><label for="{{id}}"><b data-is-private="{{is_private}}">{{name}}</b></label></div>';
  var dl_title = $('#dl_title');
  var dl_new = $('#dl_new');
  var dl_exist = $('.dl_exist_select');
  var validateRules = {
    '#dl_title': function(e) {
      if (e.val() === '') {
        var typeStr = config.cate === '1001' ? '书单' : config.cate === '1002' ? '片单' : '豆列';
        validateForm.displayError(e, '请给你的' + typeStr + '起一个名称');
        return false;
      }
      return true;
    }
  }
  if (validateForm(wrap, validateRules)) {
    var dl_new_submit = $('.dl_new_submit');
    dl_new_submit.attr('disabled', true);
    var title = $.trim($('#dl_title').val());
    var digestType = config.cate === '1001' ? 'book' : config.cate === '1002' ? 'movie' : '';
    var prefixWord = getDigestTypeText(digestType) + '｜';

    // 如果是书单、片单，标题自动加上前缀
    if (digestType && !isStartsWithPrefixWord(title, digestType)) {
      title = prefixWord + title
    }

    var params = {
      title: title,
      is_private: $('input[name="is_private"]:checked').val(),
    }

    if (config.cate === '1001' || config.cate === '1002') {
      params.category = config.cate === '1001' ? 'book' : 'movie';
    }
    asyncRequest(DOULIST_CREATE, params, 'post')
      .done(function(res) {
        if (res.r) {
          alert(res.err);
          return;
        }

        res.doulist_id = res.id;
        var DL_STR = DL_TMPL.replace(/{{[^{}]+}}/g, function(match) {
          var matched = res[match.replace(/[{}]/g, "")];
          return matched && encodeHTML(matched.toString()) || "";
        });
        var new_dl = $(DL_STR);
        new_dl.prependTo(dl_exist);
        dl_exist.find('.empty-list').remove();

        dl_exist.animate({'scrollTop': 0}, 100);
        dl_new.click();
        dl_title.val('').change();
      })
      .fail(function() {
        alert('网络问题，请稍后重试');
        dl_new_submit.removeAttr('disabled');
      });
  } else {
    dialog.update();
  }
  return wrap;
}

$.fn.doulistDialog = function(options) {
  /* local-dev */
  // options.cate = "1001"
  // options.catename =  "图书"
  // options.id = "33387422"

  return new DoulistDialog($(this), options);
};

})(jQuery);


    $(document).delegate('.lnk-doulist-add', 'click', function(e) {
      e.preventDefault();
      if(window._USER_ABNORMAL) {
          show_abnormal && show_abnormal()
          return
      }
      var self = $(this);
      var param = $.extend({'url':''}, $(this).data(), {link: this.href});
      // 兼容jquery 1.8.x
      var newParam = {};
      for (var key in param) {
        if (typeof param[key] === 'number') {
          param[key] = self.attr('data-'+key);
        }
        if (param.hasOwnProperty(key)) {
          newParam[$.camelCase(key)] = param[key];
        }
      }
      self.doulistDialog(newParam);
    });

  });
});
</script><script type="text/javascript" src="https://img9.doubanio.com/misc/mixed_static/416715aca8677bae.js"></script>
    <!-- mako -->
    
<script type="text/javascript">
function hide_readonly_form(){
    $("#readonly_form").hide();
    return false;
}
$(function(){
    $(document).delegate(".set_readonly_p", "click", function() {
        $("#readonly_form").slideDown();
        return false;
    });
    $("pre.source").each(function(){
        var cn = $(this).attr('class').split(' ');
        l = cn[1];
        s = 'rand01';
        n = cn[2];
        $(this).snippet(n,{style: s, showNum: l});
    });
    $('#note_tooltip').tooltip();
});
</script>
<script src="https://img9.doubanio.com/f/shire/bc881a837a728ab82aa01d653b1c180190bb5a5d/js/ui/dialog.js"></script>
<script src="https://img9.doubanio.com/f/shire/ab240efa59e09be0533b108a1731e09e2a782e29/js/abnormal_account.js"></script>






    
<script type="text/javascript">
    (function (global) {
        var newNode = global.document.createElement('script'),
            existingNode = global.document.getElementsByTagName('script')[0],
            adSource = '//erebor.douban.com/',
            userId = '252269522',
            browserId = '1S50d3rycE8',
            criteria = '3:/annotation/36682337/',
            preview = '',
            debug = false,
            adSlots = ['dale_book_annotation_top_right'];

        global.DoubanAdRequest = {src: adSource, uid: userId, bid: browserId, crtr: criteria, prv: preview, debug: debug};
        global.DoubanAdSlots = (global.DoubanAdSlots || []).concat(adSlots);

        newNode.setAttribute('type', 'text/javascript');
        newNode.setAttribute('src', '//img1.doubanio.com/MnJwNGlleS9mL2FkanMvY2M1OGQyNTQ2N2I2YmQzOTlmNTliMGJiMjI4MWRhZTlkNTNjYTFkZC9hZC5yZWxlYXNlLmpz');
        newNode.setAttribute('async', true);
        existingNode.parentNode.insertBefore(newNode, existingNode);
    })(this);
</script>











    
  

<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var p=(('https:' == document.location.protocol) ? 'https' : 'http'), u=p+'://fundin.douban.com/';
    _paq.push(['setTrackerUrl', u+'piwik']);
    _paq.push(['setSiteId', '100001']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; 
    g.type='text/javascript';
    g.defer=true; 
    g.async=true; 
    g.src=p+'://s.doubanio.com/dae/fundin/piwik.js';
    s.parentNode.insertBefore(g,s);
  })();
</script>

<script type="text/javascript">
var setMethodWithNs = function(namespace) {
  var ns = namespace ? namespace + '.' : ''
    , fn = function(string) {
        if(!ns) {return string}
        return ns + string
      }
  return fn
}

var gaWithNamespace = function(fn, namespace) {
  var method = setMethodWithNs(namespace)
  fn.call(this, method)
}

var _gaq = _gaq || []
  , accounts = [
      { id: 'UA-7019765-1', namespace: 'douban' }
    , { id: 'UA-7019765-16', namespace: '' }
    ]
  , gaInit = function(account) {
      gaWithNamespace(function(method) {
        gaInitFn.call(this, method, account)
      }, account.namespace)
    }
  , gaInitFn = function(method, account) {
      _gaq.push([method('_setAccount'), account.id])

      
  _gaq.push([method('_addOrganic'), 'google', 'q'])
  _gaq.push([method('_addOrganic'), 'baidu', 'wd'])
  _gaq.push([method('_addOrganic'), 'soso', 'w'])
  _gaq.push([method('_addOrganic'), 'youdao', 'q'])
  _gaq.push([method('_addOrganic'), 'so.360.cn', 'q'])
  _gaq.push([method('_addOrganic'), 'sogou', 'query'])
  if (account.namespace) {
    _gaq.push([method('_addIgnoredOrganic'), '豆瓣'])
    _gaq.push([method('_addIgnoredOrganic'), 'douban'])
    _gaq.push([method('_addIgnoredOrganic'), '豆瓣网'])
    _gaq.push([method('_addIgnoredOrganic'), 'www.douban.com'])
  }

      if (account.namespace === 'douban') {
        _gaq.push([method('_setDomainName'), '.douban.com'])
      }

        _gaq.push([method('_setCustomVar'), 1, 'responsive_view_mode', 'desktop', 3])

        _gaq.push([method('_setCustomVar'), 2, 'login_status', '1', 2]);

      _gaq.push([method('_trackPageview')])
    }

for(var i = 0, l = accounts.length; i < l; i++) {
  var account = accounts[i]
  gaInit(account)
}


;(function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
})()
</script>








    <!-- dae-web-book--default-7db554f74f-5vszh-->







































</body></html>